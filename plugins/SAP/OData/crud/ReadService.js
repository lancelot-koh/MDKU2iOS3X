"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var QueryOptionsReadParams_1 = require("./readparams/QueryOptionsReadParams");
var ReadLinkReadParams_1 = require("./readparams/ReadLinkReadParams");
var ODataHelper_1 = require("../ODataHelper");
var ErrorMessage_1 = require("../../ErrorHandling/ErrorMessage");
var ReadService = /** @class */ (function () {
    function ReadService() {
    }
    ReadService.entityFromParams = function (readParams, dataService, changeSetManager) {
        if (readParams instanceof ReadLinkReadParams_1.ReadLinkReadParams) {
            return ReadService.entityFromReadLinkReadParams(readParams, dataService, changeSetManager);
        }
        else if (readParams instanceof QueryOptionsReadParams_1.QueryOptionsReadParams) {
            return ReadService.entityFromQueryOptions(dataService, readParams.getEntitySetName(), readParams.getQueryOptions());
        }
        else {
            return this.entityFromQueryOptions(dataService, readParams.getEntitySetName(), null);
        }
    };
    ReadService.entitiesFromParams = function (readParams, dataService, changeSetManager) {
        if (readParams instanceof ReadLinkReadParams_1.ReadLinkReadParams) {
            return ReadService.entitiesFromReadLinkReadParams(readParams, dataService, changeSetManager);
        }
        else if (readParams instanceof QueryOptionsReadParams_1.QueryOptionsReadParams) {
            return ReadService.entitiesFromQueryOptions(dataService, readParams.getEntitySetName(), readParams.getQueryOptions());
        }
        else {
            return this.entitiesFromQueryOptions(dataService, readParams.getEntitySetName(), null);
        }
    };
    ReadService.entityFromReadLinkReadParams = function (readLinkReadParams, dataService, changeSetManager) {
        if (readLinkReadParams.isTargetCreatedInSameChangeSet()) {
            var pendingEntity = changeSetManager.pendingEntityFromPendingChangeSet(readLinkReadParams.getReadLink());
            if (pendingEntity == null) {
                throw Error(ErrorMessage_1.ErrorMessage.format(ErrorMessage_1.ErrorMessage.ODATA_ENTITY_READLINK_NOT_FOUND, readLinkReadParams.getReadLink()));
            }
            return pendingEntity;
        }
        else {
            var entitySet = this.getEntitySet(dataService, readLinkReadParams);
            var entityType = ODataHelper_1.ODataHelper.createEntityValue(entitySet.getEntityType());
            entityType.setReadLink(readLinkReadParams.getReadLink());
            this.loadEntity(dataService, entityType);
            return entityType;
        }
    };
    ReadService.getEntitySet = function (dataService, readLinkReadParams) {
        if (dataService != null) {
            return dataService.getEntitySet(readLinkReadParams.getEntitySetName());
        }
        throw new Error(ErrorMessage_1.ErrorMessage.ODATA_UNKNOWN_DATASERVICE_TYPE);
    };
    ReadService.loadEntity = function (dataService, entity) {
        if (dataService != null) {
            if (ODataHelper_1.ODataHelper.isOnlineProvider(dataService)) {
                // workaround for MDK-5070. Once OData SDK fixes the issue, online check will be removed
                var query = ODataHelper_1.ODataHelper.createDataQuery();
                query.setExpectSingle(true);
                dataService.loadEntity(entity, query);
            }
            else {
                dataService.loadEntity(entity);
            }
        }
        else {
            throw new Error(ErrorMessage_1.ErrorMessage.ODATA_UNKNOWN_DATASERVICE_TYPE);
        }
    };
    // A ReadLink always return one single entity, but in the context of a linking target acquisition, 
    // we only work with arrays
    ReadService.entitiesFromReadLinkReadParams = function (readLinkReadParams, dataService, changeSetManager) {
        var entities = new Array(1);
        entities[0] = this.entityFromReadLinkReadParams(readLinkReadParams, dataService, changeSetManager);
        return entities;
    };
    ReadService.entityFromQueryOptions = function (dataService, entitySetName, queryOptions) {
        var entities = this.entitiesFromQueryOptions(dataService, entitySetName, queryOptions);
        if (entities.length !== 1) {
            throw new Error(ErrorMessage_1.ErrorMessage.format(ErrorMessage_1.ErrorMessage.ODATA_MORE_THAN_1_ENTITY_RETURNED, entities.length));
        }
        return entities[0];
    };
    ReadService.entitiesFromQueryOptions = function (dataService, entitySetName, queryOptions) {
        var entityList = this.getEntityValueList(dataService, entitySetName, queryOptions);
        var entities = new Array(entityList.length());
        for (var i = 0; i < entityList.length(); i++) {
            entities[i] = entityList.get(i);
        }
        return entities;
    };
    ReadService.getEntityValueList = function (dataService, entityName, queryOptions) {
        var query = this.createQuery(dataService, entityName, queryOptions);
        return dataService.executeQuery(query).getEntityList();
    };
    ReadService.createQuery = function (dataService, entitySetName, queryOptions) {
        var query = ODataHelper_1.ODataHelper.createDataQuery();
        if (queryOptions != null) {
            query.setUrl(entitySetName + '?' + queryOptions);
        }
        else {
            query.setUrl(entitySetName);
        }
        var entitySet = dataService.getEntitySet(entitySetName);
        query = query.from(entitySet);
        return query;
    };
    return ReadService;
}());
exports.ReadService = ReadService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVhZFNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJSZWFkU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLDhFQUE2RTtBQUM3RSxzRUFBcUU7QUFDckUsOENBQTZDO0FBQzdDLGlFQUFnRTtBQUVoRTtJQUFBO0lBNEdBLENBQUM7SUEzR2UsNEJBQWdCLEdBQTlCLFVBQStCLFVBQXNCLEVBQUUsV0FBZ0IsRUFBRSxnQkFBa0M7UUFDekcsRUFBRSxDQUFDLENBQUMsVUFBVSxZQUFZLHVDQUFrQixDQUFDLENBQUMsQ0FBQztZQUM3QyxNQUFNLENBQUMsV0FBVyxDQUFDLDRCQUE0QixDQUFDLFVBQVUsRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUM3RixDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsWUFBWSwrQ0FBc0IsQ0FBQyxDQUFDLENBQUM7WUFDeEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLGdCQUFnQixFQUFFLEVBQ2xGLFVBQVUsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQ2xDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3ZGLENBQUM7SUFDSCxDQUFDO0lBRWEsOEJBQWtCLEdBQWhDLFVBQWlDLFVBQXNCLEVBQUUsV0FBZ0IsRUFBRSxnQkFBa0M7UUFDM0csRUFBRSxDQUFDLENBQUMsVUFBVSxZQUFZLHVDQUFrQixDQUFDLENBQUMsQ0FBQztZQUM3QyxNQUFNLENBQUMsV0FBVyxDQUFDLDhCQUE4QixDQUFDLFVBQVUsRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUMvRixDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxD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QUFDLENBQUM7UUFDbEMsQ0FBQztRQUNELE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVjLDhCQUFrQixHQUFqQyxVQUFrQyxXQUFnQixFQUFFLFVBQWtCLEVBQUUsWUFBb0I7UUFDMUYsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsVUFBVSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3pELENBQUM7SUFFYyx1QkFBVyxHQUExQixVQUEyQixXQUFnQixFQUFFLGFBQXFCLEVBQUUsWUFBb0I7UUFDdEYsSUFBSSxLQUFLLEdBQUcseUJBQVcsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUMxQyxFQUFFLENBQUMsQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN6QixLQUFLLENBQUMsTUFBTSxDQUFDLGFBQWEsR0FBRyxHQUFHLEdBQUcsWUFBWSxDQUFDLENBQUM7UUFDbkQsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sS0FBSyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM5QixDQUFDO1FBRUQsSUFBSSxTQUFTLEdBQUcsV0FBVyxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN4RCxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM5QixNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUNILGtCQUFDO0FBQUQsQ0FBQyxBQTVHRCxJQTRHQztBQTVHWSxrQ0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZVNldE1hbmFnZXIgfSBmcm9tICcuL0NoYW5nZVNldE1hbmFnZXInO1xuaW1wb3J0IHsgUmVhZFBhcmFtcyB9IGZyb20gJy4vcmVhZHBhcmFtcy9SZWFkUGFyYW1zJztcbmltcG9ydCB7IFF1ZXJ5T3B0aW9uc1JlYWRQYXJhbXMgfSBmcm9tICcuL3JlYWRwYXJhbXMvUXVlcnlPcHRpb25zUmVhZFBhcmFtcyc7XG5pbXBvcnQgeyBSZWFkTGlua1JlYWRQYXJhbXMgfSBmcm9tICcuL3JlYWRwYXJhbXMvUmVhZExpbmtSZWFkUGFyYW1zJztcbmltcG9ydCB7IE9EYXRhSGVscGVyIH0gZnJvbSAnLi4vT0RhdGFIZWxwZXInO1xuaW1wb3J0IHsgRXJyb3JNZXNzYWdlIH0gZnJvbSAnLi4vLi4vRXJyb3JIYW5kbGluZy9FcnJvck1lc3NhZ2UnO1xuXG5leHBvcnQgY2xhc3MgUmVhZFNlcnZpY2Uge1xuICBwdWJsaWMgc3RhdGljIGVudGl0eUZyb21QYXJhbXMocmVhZFBhcmFtczogUmVhZFBhcmFtcywgZGF0YVNlcnZpY2U6IGFueSwgY2hhbmdlU2V0TWFuYWdlcjogQ2hhbmdlU2V0TWFuYWdlcik6IGFueSB7XG4gICAgaWYgKHJlYWRQYXJhbXMgaW5zdGFuY2VvZiBSZWFkTGlua1JlYWRQYXJhbXMpIHtcbiAgICAgIHJldHVybiBSZWFkU2VydmljZS5lbnRpdHlGcm9tUmVhZExpbmtSZWFkUGFyYW1zKHJlYWRQYXJhbXMsIGRhdGFTZXJ2aWNlLCBjaGFuZ2VTZXRNYW5hZ2VyKTtcbiAgICB9IGVsc2UgaWYgKHJlYWRQYXJhbXMgaW5zdGFuY2VvZiBRdWVyeU9wdGlvbnNSZWFkUGFyYW1zKSB7XG4gICAgICByZXR1cm4gUmVhZFNlcnZpY2UuZW50aXR5RnJvbVF1ZXJ5T3B0aW9ucyhkYXRhU2VydmljZSwgcmVhZFBhcmFtcy5nZXRFbnRpdHlTZXROYW1lKCksIFxuICAgICAgICByZWFkUGFyYW1zLmdldFF1ZXJ5T3B0aW9ucygpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuZW50aXR5RnJvbVF1ZXJ5T3B0aW9ucyhkYXRhU2VydmljZSwgcmVhZFBhcmFtcy5nZXRFbnRpdHlTZXROYW1lKCksIG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZW50aXRpZXNGcm9tUGFyYW1zKHJlYWRQYXJhbXM6IFJlYWRQYXJhbXMsIGRhdGFTZXJ2aWNlOiBhbnksIGNoYW5nZVNldE1hbmFnZXI6IENoYW5nZVNldE1hbmFnZXIpOiBhbnkge1xuICAgIGlmIChyZWFkUGFyYW1zIGluc3RhbmNlb2YgUmVhZExpbmtSZWFkUGFyYW1zKSB7XG4gICAgICByZXR1cm4gUmVhZFNlcnZpY2UuZW50aXRpZXNGcm9tUmVhZExpbmtSZWFkUGFyYW1zKHJlYWRQYXJhbXMsIGRhdGFTZXJ2aWNlLCBjaGFuZ2VTZXRNYW5hZ2VyKTtcbiAgICB9IGVsc2UgaWYgKHJlYWRQYXJhbXMgaW5zdGFuY2VvZiBRdWVyeU9wdGlvbnNSZWFkUGFyYW1zKSB7XG4gICAgICByZXR1cm4gUmVhZFNlcnZpY2UuZW50aXRpZXNGcm9tUXVlcnlPcHRpb25zKGRhdGFTZXJ2aWNlLCByZWFkUGFyYW1zLmdldEVudGl0eVNldE5hbWUoKSwgXG4gICAgICAgIHJlYWRQYXJhbXMuZ2V0UXVlcnlPcHRpb25zKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5lbnRpdGllc0Zyb21RdWVyeU9wdGlvbnMoZGF0YVNlcnZpY2UsIHJlYWRQYXJhbXMuZ2V0RW50aXR5U2V0TmFtZSgpLCBudWxsKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBlbnRpdHlGcm9tUmVhZExpbmtSZWFkUGFyYW1zKHJlYWRMaW5rUmVhZFBhcmFtczogUmVhZExpbmtSZWFkUGFyYW1zLCBkYXRhU2VydmljZTogYW55LCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VTZXRNYW5hZ2VyOiBDaGFuZ2VTZXRNYW5hZ2VyKTogYW55IHtcbiAgICBpZiAocmVhZExpbmtSZWFkUGFyYW1zLmlzVGFyZ2V0Q3JlYXRlZEluU2FtZUNoYW5nZVNldCgpKSB7XG4gICAgICBsZXQgcGVuZGluZ0VudGl0eSA9IGNoYW5nZVNldE1hbmFnZXIucGVuZGluZ0VudGl0eUZyb21QZW5kaW5nQ2hhbmdlU2V0KHJlYWRMaW5rUmVhZFBhcmFtcy5nZXRSZWFkTGluaygpKTtcbiAgICAgIGlmIChwZW5kaW5nRW50aXR5ID09IG51bGwpICB7XG4gICAgICAgIHRocm93IEVycm9yKEVycm9yTWVzc2FnZS5mb3JtYXQoRXJyb3JNZXNzYWdlLk9EQVRBX0VOVElUWV9SRUFETElOS19OT1RfRk9VTkQsIFxuICAgICAgICAgIHJlYWRMaW5rUmVhZFBhcmFtcy5nZXRSZWFkTGluaygpKSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcGVuZGluZ0VudGl0eTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGVudGl0eVNldCA9IHRoaXMuZ2V0RW50aXR5U2V0KGRhdGFTZXJ2aWNlLCByZWFkTGlua1JlYWRQYXJhbXMpO1xuICAgICAgbGV0IGVudGl0eVR5cGUgPSBPRGF0YUhlbHBlci5jcmVhdGVFbnRpdHlWYWx1ZShlbnRpdHlTZXQuZ2V0RW50aXR5VHlwZSgpKTtcbiAgICAgIGVudGl0eVR5cGUuc2V0UmVhZExpbmsocmVhZExpbmtSZWFkUGFyYW1zLmdldFJlYWRMaW5rKCkpO1xuICAgICAgdGhpcy5sb2FkRW50aXR5KGRhdGFTZXJ2aWNlLCBlbnRpdHlUeXBlKTtcbiAgICAgIHJldHVybiBlbnRpdHlUeXBlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGdldEVudGl0eVNldChkYXRhU2VydmljZTogYW55LCByZWFkTGlua1JlYWRQYXJhbXM6IFJlYWRMaW5rUmVhZFBhcmFtcyk6IGFueSB7XG4gICAgaWYgKGRhdGFTZXJ2aWNlICE9IG51bGwpIHtcbiAgICAgIHJldHVybiBkYXRhU2VydmljZS5nZXRFbnRpdHlTZXQocmVhZExpbmtSZWFkUGFyYW1zLmdldEVudGl0eVNldE5hbWUoKSk7XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKEVycm9yTWVzc2FnZS5PREFUQV9VTktOT1dOX0RBVEFTRVJWSUNFX1RZUEUpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgbG9hZEVudGl0eShkYXRhU2VydmljZTogYW55LCBlbnRpdHk6IGFueSk6IHZvaWQge1xuICAgIGlmIChkYXRhU2VydmljZSAhPSBudWxsKSB7XG4gICAgICBpZiAoT0RhdGFIZWxwZXIuaXNPbmxpbmVQcm92aWRlcihkYXRhU2VydmljZSkpIHtcbiAgICAgICAgLy8gd29ya2Fyb3VuZCBmb3IgTURLLTUwNzAuIE9uY2UgT0RhdGEgU0RLIGZpeGVzIHRoZSBpc3N1ZSwgb25saW5lIGNoZWNrIHdpbGwgYmUgcmVtb3ZlZFxuICAgICAgICBsZXQgcXVlcnkgPSBPRGF0YUhlbHBlci5jcmVhdGVEYXRhUXVlcnkoKTtcbiAgICAgICAgcXVlcnkuc2V0RXhwZWN0U2luZ2xlKHRydWUpO1xuICAgICAgICBkYXRhU2VydmljZS5sb2FkRW50aXR5KGVudGl0eSwgcXVlcnkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGF0YVNlcnZpY2UubG9hZEVudGl0eShlbnRpdHkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoRXJyb3JNZXNzYWdlLk9EQVRBX1VOS05PV05fREFUQVNFUlZJQ0VfVFlQRSk7XG4gICAgfVxuICB9XG5cbiAgLy8gQSBSZWFkTGluayBhbHdheXMgcmV0dXJuIG9uZSBzaW5nbGUgZW50aXR5LCBidXQgaW4gdGhlIGNvbnRleHQgb2YgYSBsaW5raW5nIHRhcmdldCBhY3F1aXNpdGlvbiwgXG4gIC8vIHdlIG9ubHkgd29yayB3aXRoIGFycmF5c1xuICBwcml2YXRlIHN0YXRpYyBlbnRpdGllc0Zyb21SZWFkTGlua1JlYWRQYXJhbXMocmVhZExpbmtSZWFkUGFyYW1zOiBSZWFkTGlua1JlYWRQYXJhbXMsIGRhdGFTZXJ2aWNlOiBhbnksIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlU2V0TWFuYWdlcjogQ2hhbmdlU2V0TWFuYWdlcik6IGFueSB7XG4gICAgbGV0IGVudGl0aWVzID0gbmV3IEFycmF5KDEpO1xuICAgIGVudGl0aWVzWzBdID0gdGhpcy5lbnRpdHlGcm9tUmVhZExpbmtSZWFkUGFyYW1zKHJlYWRMaW5rUmVhZFBhcmFtcywgZGF0YVNlcnZpY2UsIGNoYW5nZVNldE1hbmFnZXIpO1xuICAgIHJldHVybiBlbnRpdGllcztcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGVudGl0eUZyb21RdWVyeU9wdGlvbnMoZGF0YVNlcnZpY2U6IGFueSwgZW50aXR5U2V0TmFtZTogc3RyaW5nLCBxdWVyeU9wdGlvbnM6IHN0cmluZyk6IHZvaWQge1xuICAgIGxldCBlbnRpdGllcyA9IHRoaXMuZW50aXRpZXNGcm9tUXVlcnlPcHRpb25zKGRhdGFTZXJ2aWNlLCBlbnRpdHlTZXROYW1lLCBxdWVyeU9wdGlvbnMpO1xuXG4gICAgaWYgKGVudGl0aWVzLmxlbmd0aCAhPT0gMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKEVycm9yTWVzc2FnZS5mb3JtYXQoRXJyb3JNZXNzYWdlLk9EQVRBX01PUkVfVEhBTl8xX0VOVElUWV9SRVRVUk5FRCwgZW50aXRpZXMubGVuZ3RoKSk7XG4gICAgfVxuICAgIHJldHVybiBlbnRpdGllc1swXTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGVudGl0aWVzRnJvbVF1ZXJ5T3B0aW9ucyhkYXRhU2VydmljZTogYW55LCBlbnRpdHlTZXROYW1lOiBzdHJpbmcsIHF1ZXJ5T3B0aW9uczogc3RyaW5nKTogYW55IHtcbiAgICBsZXQgZW50aXR5TGlzdCA9IHRoaXMuZ2V0RW50aXR5VmFsdWVMaXN0KGRhdGFTZXJ2aWNlLCBlbnRpdHlTZXROYW1lLCBxdWVyeU9wdGlvbnMpO1xuICAgIGxldCBlbnRpdGllcyA9IG5ldyBBcnJheShlbnRpdHlMaXN0Lmxlbmd0aCgpKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudGl0eUxpc3QubGVuZ3RoKCk7IGkrKykge1xuICAgICAgZW50aXRpZXNbaV0gPSBlbnRpdHlMaXN0LmdldChpKTtcbiAgICB9XG4gICAgcmV0dXJuIGVudGl0aWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0RW50aXR5VmFsdWVMaXN0KGRhdGFTZXJ2aWNlOiBhbnksIGVudGl0eU5hbWU6IHN0cmluZywgcXVlcnlPcHRpb25zOiBzdHJpbmcpOiBhbnkge1xuICAgIGxldCBxdWVyeSA9IHRoaXMuY3JlYXRlUXVlcnkoZGF0YVNlcnZpY2UsIGVudGl0eU5hbWUsIHF1ZXJ5T3B0aW9ucyk7XG4gICAgcmV0dXJuIGRhdGFTZXJ2aWNlLmV4ZWN1dGVRdWVyeShxdWVyeSkuZ2V0RW50aXR5TGlzdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlUXVlcnkoZGF0YVNlcnZpY2U6IGFueSwgZW50aXR5U2V0TmFtZTogc3RyaW5nLCBxdWVyeU9wdGlvbnM6IHN0cmluZyk6IHZvaWQge1xuICAgIGxldCBxdWVyeSA9IE9EYXRhSGVscGVyLmNyZWF0ZURhdGFRdWVyeSgpO1xuICAgIGlmIChxdWVyeU9wdGlvbnMgIT0gbnVsbCkge1xuICAgICAgcXVlcnkuc2V0VXJsKGVudGl0eVNldE5hbWUgKyAnPycgKyBxdWVyeU9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBxdWVyeS5zZXRVcmwoZW50aXR5U2V0TmFtZSk7XG4gICAgfVxuXG4gICAgbGV0IGVudGl0eVNldCA9IGRhdGFTZXJ2aWNlLmdldEVudGl0eVNldChlbnRpdHlTZXROYW1lKTtcbiAgICBxdWVyeSA9IHF1ZXJ5LmZyb20oZW50aXR5U2V0KTtcbiAgICByZXR1cm4gcXVlcnk7XG4gIH1cbn1cbiJdfQ==